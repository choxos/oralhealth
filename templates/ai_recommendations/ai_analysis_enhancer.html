<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find the AI analysis content area
    const analysisContent = document.querySelector('.ai-analysis-content, .xera-card-body');
    
    if (!analysisContent) return;
    
    // Get the raw text content
    let content = analysisContent.innerHTML;
    
    // Enhanced formatting function
    function enhanceAIAnalysis(text) {
        // Split into sections based on headers
        let enhanced = text;
        
        // Detect and enhance sections
        enhanced = enhanced.replace(
            /(This patient presents.*?)(\n\n|\r\n\r\n|$)/gis,
            '<div class="risk-section"><h5><i class="fas fa-exclamation-triangle me-2"></i>Risk Assessment</h5>$1</div>'
        );
        
        // Personalized Advice section
        enhanced = enhanced.replace(
            /(Personalized Advice.*?)(?=Priority Actions|$)/gis,
            '<div class="advice-section"><h5><i class="fas fa-lightbulb me-2"></i>Personalized Advice</h5>$1</div>'
        );
        
        // Priority Actions section
        enhanced = enhanced.replace(
            /(Priority Actions.*?)$/gis,
            '<div class="priority-section"><h5><i class="fas fa-tasks me-2"></i>Priority Actions</h5>$1</div>'
        );
        
        // Format bullet points with proper HTML lists
        enhanced = enhanced.replace(/\* \*\*(.*?)\*\*(.*?)(?=\n\*|\n[A-Z]|\n\d\.|\n\n|$)/g, function(match, boldText, restText) {
            return `<li><strong>${boldText.trim()}</strong>${restText.trim()}</li>`;
        });
        
        // Format numbered lists
        enhanced = enhanced.replace(/(\d+\.\s+\*\*(.*?)\*\*(.*?)(?=\n\d\.|\n[A-Z]|\n\n|$))/g, function(match, full, boldText, restText) {
            return `<li><strong>${boldText.trim()}</strong>${restText.trim()}</li>`;
        });
        
        // Wrap consecutive list items in ul tags
        enhanced = enhanced.replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs, '<ul>$1</ul>');
        
        // Format bold text that's not already in HTML
        enhanced = enhanced.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Format headings
        enhanced = enhanced.replace(/^([A-Z][^a-z\n]*?)$/gm, '<h6 class="text-primary mt-3 mb-2">$1</h6>');
        
        // Format paragraphs
        enhanced = enhanced.replace(/\n\n/g, '</p><p>');
        enhanced = '<p>' + enhanced + '</p>';
        
        // Clean up empty paragraphs
        enhanced = enhanced.replace(/<p>\s*<\/p>/g, '');
        enhanced = enhanced.replace(/<p>\s*(<div|<ul|<ol|<h[1-6])/g, '$1');
        enhanced = enhanced.replace(/(<\/div>|<\/ul>|<\/ol>|<\/h[1-6]>)\s*<\/p>/g, '$1');
        
        return enhanced;
    }
    
    // Apply enhanced formatting
    const enhancedContent = enhanceAIAnalysis(content);
    analysisContent.innerHTML = enhancedContent;
    
    // Add the CSS class for styling
    analysisContent.classList.add('ai-analysis-content');
    
    // Add smooth scroll behavior for long content
    if (analysisContent.scrollHeight > window.innerHeight) {
        analysisContent.style.maxHeight = '80vh';
        analysisContent.style.overflowY = 'auto';
        analysisContent.style.scrollBehavior = 'smooth';
    }
    
    // Add copy-to-clipboard functionality
    const copyButton = document.createElement('button');
    copyButton.className = 'btn btn-outline-primary btn-sm mt-3';
    copyButton.innerHTML = '<i class="fas fa-copy me-1"></i>Copy Analysis';
    copyButton.onclick = function() {
        const textContent = analysisContent.innerText;
        navigator.clipboard.writeText(textContent).then(function() {
            copyButton.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
            copyButton.classList.remove('btn-outline-primary');
            copyButton.classList.add('btn-success');
            setTimeout(function() {
                copyButton.innerHTML = '<i class="fas fa-copy me-1"></i>Copy Analysis';
                copyButton.classList.remove('btn-success');
                copyButton.classList.add('btn-outline-primary');
            }, 2000);
        });
    };
    
    // Insert copy button after the analysis
    const cardBody = analysisContent.closest('.xera-card-body');
    if (cardBody) {
        cardBody.appendChild(copyButton);
    }
    
    // Add print functionality
    const printButton = document.createElement('button');
    printButton.className = 'btn btn-outline-secondary btn-sm mt-3 ms-2';
    printButton.innerHTML = '<i class="fas fa-print me-1"></i>Print';
    printButton.onclick = function() {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Oral Health Recommendations</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    .ai-analysis-content { line-height: 1.6; }
                    .risk-section, .advice-section, .priority-section { 
                        margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; 
                        background: #f8f9fa; page-break-inside: avoid; 
                    }
                    ul li { margin-bottom: 8px; }
                    ol li { margin-bottom: 10px; }
                    h5, h6 { color: #007bff; margin-top: 20px; }
                </style>
            </head>
            <body>
                <h1>Your Personalized Oral Health Recommendations</h1>
                <div class="ai-analysis-content">${analysisContent.innerHTML}</div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };
    
    if (cardBody) {
        cardBody.appendChild(printButton);
    }
});
</script>